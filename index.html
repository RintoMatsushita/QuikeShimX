<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>åœ°éœ‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ vÎ²ï¼ˆUIæ”¹è‰¯ï¼‹æ´¥æ³¢æ©Ÿèƒ½ï¼‰</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<style>
:root{ --bg:#070d14; --panel:#0d1620; --muted:#9fb0b8; --accent:#57c7ff; --glass:rgba(255,255,255,0.06) }
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#020305,var(--bg));color:#eaf6ff;font-family:"Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial}
button{cursor:pointer;border:none;border-radius:10px;padding:10px 14px;background:rgba(255,255,255,0.08);color:#eaf6ff;transition:all .2s}
button.primary{background:linear-gradient(180deg,var(--accent),#2aa8d6);color:#05131a;font-weight:800}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted)}
button:hover{opacity:0.85}
input[type="number"],input[type="text"],select,input[type="range"],input[type="url"],input[type="password"]{width:100%;padding:8px;border-radius:10px;border:none;background:rgba(255,255,255,0.08);color:#eaf6ff}
label{display:block;color:var(--muted);font-size:12px;margin:6px 0 4px}
small,.small{color:var(--muted);font-size:12px}

/* Title */
#title{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.55),rgba(0,0,0,0.8));z-index:1000}
#titleCard{width:min(1180px,96vw);height:min(760px,94vh);display:grid;grid-template-columns:1fr 380px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,0.08);background:linear-gradient(180deg,#08101e,#0b121b);box-shadow:0 30px 80px rgba(0,0,0,0.65)}
#tLeft{padding:26px;display:flex;gap:12px;flex-direction:column}
#tLeft h1{margin:0;font-size:34px;color:var(--accent)}
#titleMap{flex:1;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.06);background:#fff;display:flex;align-items:center;justify-content:center}
#tRight{padding:18px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent)}
.slide{background:var(--glass);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);min-height:150px;display:flex;flex-direction:column;gap:8px}
.slideNav{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
.titleBtns{display:flex;gap:10px;flex-wrap:wrap}
#btnStart{font-size:18px;padding:12px 20px}
@media (max-width:980px){ #titleCard{grid-template-columns:1fr} #btnStart{width:100%} }

/* Main layout */
#app{display:none;height:100vh;padding:10px}
.layout{display:grid;grid-template-columns:1fr 390px;gap:12px;height:calc(100vh - 20px)}
@media (max-width:1120px){ .layout{grid-template-columns:1fr} #panel{height:48vh} }
#mapWrap{position:relative}
#map{width:100%;height:100%;min-height:54vh;border-radius:14px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:1}

/* Right panel */
/* å³ãƒ‘ãƒãƒ«å…¨ä½“ã«å¸¸ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’è¡¨ç¤º */
#panel {
  background:rgba(20, 30, 40, 0.6);
  backdrop-filter:blur(8px);
  border-radius:14px;
  padding:10px;
  overflow-y: auto; /* å¸¸ã«ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ */
  overflow-x: hidden;
  box-shadow:0 10px 30px rgba(0,0,0,0.45);
  display:flex;
  flex-direction:column;
  gap:10px;
  scrollbar-gutter: stable;
}

/* å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
#panel::-webkit-scrollbar { width:10px; }
#panel::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.18); border-radius:8px; }
#panel::-webkit-scrollbar-track { background:rgba(255,255,255,0.06); border-radius:8px; }

/* å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚‚ç¶­æŒ */
.section .content { max-height:240px; overflow-y: auto; padding-right:6px; }
.section .content::-webkit-scrollbar { width:8px; }
.section .content::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.2); border-radius:4px; }
.section .content::-webkit-scrollbar-track { background:rgba(255,255,255,0.05); }
.section summary::-webkit-details-marker{display:none}
.section summary::before{ content:"ğŸ“Œ"; margin-right:6px; }
.section .content{ padding:10px 12px; display:grid; gap:10px; max-height:240px; overflow-y:auto; padding-right:6px; }
.section .content::-webkit-scrollbar{width:8px}
.section .content::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:4px}
.section .content::-webkit-scrollbar-track{background:rgba(255,255,255,0.05)}

.twoCol{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:520px){ .twoCol{grid-template-columns:1fr} }

/* HUD */
.hud{position:absolute;left:14px;top:14px;background:rgba(0,0,0,0.6);padding:8px 10px;border-radius:10px;color:#d2e6f0;z-index:1200}
.badge{position:absolute;right:14px;top:14px;background:rgba(0,0,0,0.6);padding:8px 10px;border-radius:10px;color:#d2e6f0;z-index:1200}
.version{position:fixed;left:12px;bottom:12px;color:var(--muted);font-size:12px;z-index:1500}

/* Station/Epic Icons */
.station-dot{display:flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:999px;background:#57c7ff;color:#061015;font-weight:800;font-size:12px;border:2px solid rgba(0,0,0,0.2);box-shadow:0 2px 10px rgba(0,0,0,0.25)}
.station-label{position:absolute;top:-18px;white-space:nowrap;background:rgba(0,0,0,0.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:11px}
.countdown-pill{position:absolute;top:22px;white-space:nowrap;background:rgba(0,0,0,0.6);color:#fff;padding:2px 6px;border-radius:6px;font-size:11px}
.epi-dot{width:18px;height:18px;border-radius:999px;background:#ff6b6b;border:2px solid #d74f4f;box-shadow:0 2px 10px rgba(0,0,0,0.25)}

/* Overlay */
#overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:5000}
#obg{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.55),rgba(0,0,0,0.85));backdrop-filter:blur(2px)}
#op{position:relative;z-index:2;background:linear-gradient(180deg,#172026,#0e1417);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);width:min(820px,94vw);color:#fff}
#op h3{margin:0 0 8px 0;color:#ffcc66}
</style>
</head>
<body>

<!-- ===== Title & Tutorial ===== -->
<div id="title">
  <div id="titleCard">
    <div id="tLeft">
      <h1>åœ°éœ‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ vÎ²</h1>
      <div id="titleMap">
        <svg viewBox="0 0 1600 1200" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
          <rect width="100%" height="100%" fill="#ffffff"/>
          <path d="M980 140l40 40-20 60 40 60-10 60 50 50-30 70 60 40-30 80 40 70-60 20-50-20-40 30-70-10-40 30-60-10-60-50-70-10-50-40-40-60-30-80 20-70 40-60 60-40 90-20 80-30 70-10 60-10z" fill="#dfe8ef" stroke="#333" stroke-width="2"/>
          <text x="16" y="28" font-size="18" fill="#333">Japan (embedded)</text>
        </svg>
      </div>
      <div class="titleBtns">
        <button id="btnStart" class="primary">é–‹å§‹</button>
        <button id="btnTutorial" class="ghost">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«</button>
        <button id="btnAIMode" class="ghost">AIæ¨è«–ãƒ¢ãƒ¼ãƒ‰</button>
      </div>
      <small>ã‚¹ãƒãƒ›ï¼šãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—=è¦³æ¸¬ç‚¹ã€2æœ¬æŒ‡=ã‚ºãƒ¼ãƒ ã€1æœ¬æŒ‡ãƒ‰ãƒ©ãƒƒã‚°=ãƒ‘ãƒ³ï¼ˆãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰æ¨å¥¨ï¼‰ã€‚</small>
    </div>

    <div id="tRight">
      <div class="slide" data-s="0">
        <h3>1/3 ã¯ã˜ã‚ã«</h3>
        <p class="small">ãƒ„ãƒ¼ãƒ«ï¼šéœ‡æºï¼ˆæœ€å¤§5ï¼‰/è¦³æ¸¬ç‚¹ï¼ˆé’ï¼‰ã‚’è¿½åŠ ç·¨é›†ã€‚ãƒ“ãƒ¥ãƒ¼ï¼šç·¨é›†ç„¡åŠ¹ãƒ»ã‚ºãƒ¼ãƒ /ãƒ‘ãƒ³ã®ã¿ã€‚Såˆ°é”ã§éœ‡åº¦ãƒãƒƒã‚¸è¡¨ç¤ºã€‚</p>
        <div class="slideNav">
          <div class="small" id="slideIndex">ã‚¹ãƒ©ã‚¤ãƒ‰ 1 / 3</div>
          <div>
            <button id="prevSlide" class="ghost" disabled>å‰ã¸</button>
            <button id="nextSlide" class="ghost">æ¬¡ã¸</button>
          </div>
        </div>
      </div>
      <div class="slide" data-s="1" style="display:none">
        <h3>2/3 è¿½åŠ æ–¹æ³•</h3>
        <p class="small">åœ°å›³ã‚¯ãƒªãƒƒã‚¯=éœ‡æºã€<b>ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—/ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯=è¦³æ¸¬ç‚¹</b>ã€‚è¦³æ¸¬ç‚¹ã¯é’ä¸¸ã€‚åå‰ã¯ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ã€‚</p>
        <div class="slideNav">
          <div class="small">ã‚¹ãƒ©ã‚¤ãƒ‰ 2 / 3</div>
          <div>
            <button class="ghost" id="prev2">å‰ã¸</button>
            <button class="ghost" id="next2">æ¬¡ã¸</button>
          </div>
        </div>
      </div>
      <div class="slide" data-s="2" style="display:none">
        <h3>3/3 åœ°å›³ã¨ç‰©ç†</h3>
        <p class="small">P/Sé€Ÿåº¦ã‚„è·é›¢æ¸›è¡° d ã‚’èª¿æ•´ã€‚åœ°å›³é€æ˜åº¦ã‚¹ãƒ©ã‚¤ãƒ€ã§èƒŒæ™¯ã‚’è–„ãã§ãã¾ã™ã€‚</p>
        <div class="slideNav">
          <div class="small">ã‚¹ãƒ©ã‚¤ãƒ‰ 3 / 3</div>
          <div>
            <button class="ghost" id="prev3">å‰ã¸</button>
            <button class="primary" id="startFromSlide">é–‹å§‹</button>
          </div>
        </div>
      </div>
      <small>AIæ¨è«–ã¯åˆ¥ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«åˆ‡æ›¿ï¼ˆå¤–éƒ¨APIæ‹¡å¼µãƒã‚¤ãƒ³ãƒˆã‚ã‚Šï¼‰ã€‚</small>
    </div>
  </div>
</div>

<!-- ===== Main App ===== -->
<div id="app">
  <div class="layout">
    <div id="mapWrap">
      <div id="map"></div>
      <div class="hud" id="hud">ãƒ„ãƒ¼ãƒ«: ã‚¯ãƒªãƒƒã‚¯=éœ‡æº / ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—=è¦³æ¸¬ç‚¹ / ãƒ‰ãƒ©ãƒƒã‚°=ç§»å‹•</div>
      <div class="badge" id="modeBadge">Mode: TOOL</div>
    </div>

    <aside id="panel">
      <!-- ã‚·ãƒŸãƒ¥ -->
      <details class="section" open>
        <summary>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ / ãƒ¢ãƒ¼ãƒ‰</summary>
        <div class="content">
          <div class="twoCol">
            <button id="runStart" class="primary">Start</button>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="runPause" class="ghost" disabled>Pause</button>
              <button id="runResume" class="ghost" disabled>Resume</button>
              <button id="runStop" class="ghost" disabled>Stop</button>
            </div>
          </div>
          <div class="twoCol">
            <div>
              <label>ãƒ¢ãƒ¼ãƒ‰</label>
              <select id="modeSel">
                <option value="TOOL">ãƒ„ãƒ¼ãƒ«</option>
                <option value="VIEW">ãƒ“ãƒ¥ãƒ¼</option>
                <option value="AI">AIæ¨è«–</option>
              </select>
            </div>
            <div>
              <label>å†ç”Ÿé€Ÿåº¦</label>
              <input id="speed" type="range" min="0.25" max="4" step="0.05" value="1">
            </div>
          </div>
          <small>é–‹å§‹æ™‚ã¯è‡ªå‹•ã§ãƒ“ãƒ¥ãƒ¼ã¸ï¼ˆç·¨é›†ç„¡åŠ¹ï¼ã‚ºãƒ¼ãƒ &ãƒ‘ãƒ³ã®ã¿ï¼‰ã€‚</small>
        </div>
      </details>

      <!-- ã‚µã‚¦ãƒ³ãƒ‰ & èª­ã¿ä¸Šã’ -->
      <details class="section" open>
        <summary>ã‚µã‚¦ãƒ³ãƒ‰ / èª­ã¿ä¸Šã’</summary>
        <div class="content">
          <div class="twoCol">
            <div>
              <label>ãƒŸãƒ¥ãƒ¼ãƒˆ</label>
              <select id="muteSel">
                <option value="off">Off</option>
                <option value="on">On</option>
              </select>
            </div>
            <div>
              <label>éŸ³é‡</label>
              <input id="vol" type="range" min="0" max="1" step="0.01" value="0.35">
            </div>
          </div>
          <div class="twoCol">
            <div>
              <label>TTSï¼ˆäºˆæƒ³éœ‡åº¦ã®èª­ã¿ä¸Šã’ï¼‰</label>
              <select id="ttsMode">
                <option value="off">ã‚ªãƒ•</option>
                <option value="all">å…¨ã¦èª­ã¿ä¸Šã’</option>
                <option value="major">ä¸»è¦éƒ½å¸‚ã®ã¿</option>
                <option value="jma5">5å¼±ä»¥ä¸Šã®ã¿</option>
              </select>
            </div>
            <div>
              <label>è©±é€Ÿ</label>
              <input id="ttsRate" type="range" min="0.7" max="1.3" step="0.05" value="1.0">
            </div>
          </div>
        </div>
      </details>

      <!-- éœ‡æº -->
      <details class="section" open>
        <summary>éœ‡æºï¼ˆæœ€å¤§5ï¼‰</summary>
        <div class="content">
          <div class="twoCol">
            <div><label>M</label><input id="inMag" type="number" step="0.1" min="-2" max="12" value="6.5"></div>
            <div><label>æ·±ã•(km)</label><input id="inDepth" type="number" step="0.1" min="0.1" max="750" value="30"></div>
          </div>
          <button id="btnAddEpic" class="primary">åœ°å›³ä¸­å¿ƒã«éœ‡æºè¿½åŠ </button>
          <div id="epicList" class="small" style="color:var(--muted)">éœ‡æºãªã—</div>
        </div>
      </details>

      <!-- è¦³æ¸¬ç‚¹ -->
      <details class="section" open>
        <summary>è¦³æ¸¬ç‚¹ï¼ˆé’ä¸¸ï¼‰</summary>
        <div class="content">
          <div class="twoCol">
            <div><label>åå‰</label><input id="stName" type="text" placeholder="ä¾‹: æ±äº¬"></div>
            <div class="twoCol" style="grid-template-columns:1fr 1fr">
              <div><label>ç·¯åº¦</label><input id="stLat" type="number" step="0.0001" placeholder="35.68"></div>
              <div><label>çµŒåº¦</label><input id="stLon" type="number" step="0.0001" placeholder="139.76"></div>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnAddStation" class="primary">åœ°å›³ä¸­å¿ƒã«è¿½åŠ </button>
            <button id="btnClearStations" class="ghost">å…¨å‰Šé™¤</button>
          </div>
          <div id="stList" class="small" style="color:var(--muted)">è¦³æ¸¬ç‚¹ãªã—</div>
        </div>
      </details>

      <!-- åœ°å›³/è¡¨ç¤º -->
      <details class="section">
        <summary>åœ°å›³ / è¡¨ç¤º</summary>
        <div class="content">
          <div class="twoCol">
            <div>
              <label>ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—</label>
              <select id="tileSel">
                <option value="osm">OSM æ¨™æº–</option>
                <option value="bright">Carto Bright</option>
                <option value="toner">Stamen Toner</option>
              </select>
            </div>
            <div>
              <label>åœ°å›³é€æ˜åº¦</label>
              <input id="tileOpacity" type="range" min="0.2" max="1" step="0.02" value="1">
            </div>
          </div>
          <div class="twoCol">
            <div>
              <label>P/Sãƒªãƒ³ã‚°</label>
              <select id="ringVis">
                <option value="on">è¡¨ç¤º</option>
                <option value="off">éè¡¨ç¤º</option>
              </select>
            </div>
            <div>
              <label>HUDè¡¨ç¤º</label>
              <select id="hudVis">
                <option value="on">è¡¨ç¤º</option>
                <option value="off">éè¡¨ç¤º</option>
              </select>
            </div>
          </div>
        </div>
      </details>

      <!-- ç‰©ç†ã‚¹ã‚±ãƒ¼ãƒ« -->
      <details class="section">
        <summary>ç‰©ç†ã‚¹ã‚±ãƒ¼ãƒ« / æ¨å®š</summary>
        <div class="content">
          <div class="twoCol">
            <div><label>Pæ³¢é€Ÿåº¦ Vp (km/s)</label><input id="vp" type="number" step="0.1" value="6.0"></div>
            <div><label>Sæ³¢é€Ÿåº¦ Vs (km/s)</label><input id="vs" type="number" step="0.1" value="3.5"></div>
          </div>
          <div class="twoCol">
            <div>
              <label>è·é›¢æ¸›è¡° d (1/km)</label>
              <input id="att" type="range" min="0" max="0.008" step="0.0001" value="0.0035">
              <small>log10PGA â‰ˆ a+bMâˆ’cÂ·log10R âˆ’ dÂ·Rï¼ˆR:æ–œè·é›¢kmï¼‰</small>
            </div>
            <div>
              <label>æ¸›è¡°ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
              <select id="modelPreset">
                <option value="default" selected>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                <option value="dStrong">é è·é›¢å¼·ã‚ï¼ˆd=0.005ï¼‰</option>
                <option value="dLight">é è·é›¢å¼±ã‚ï¼ˆd=0.002ï¼‰</option>
              </select>
            </div>
          </div>
        </div>
      </details>

      <!-- æ´¥æ³¢ï¼ˆç°¡æ˜“ï¼‰ -->
      <details class="section" open>
        <summary>æ´¥æ³¢ï¼ˆç°¡æ˜“ï¼‰</summary>
        <div class="content">
          <div class="twoCol">
            <div>
              <label>æ´¥æ³¢ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</label>
              <select id="tsuMode">
                <option value="off" selected>ã‚ªãƒ•</option>
                <option value="on">ã‚ªãƒ³</option>
              </select>
            </div>
            <div>
              <label>æ´¥æ³¢ãƒªãƒ³ã‚°</label>
              <select id="tsuRingVis">
                <option value="on">è¡¨ç¤º</option>
                <option value="off" selected>éè¡¨ç¤º</option>
              </select>
            </div>
          </div>
          <div class="twoCol">
            <div>
              <label>å¹³å‡æ°´æ·± h (m)</label>
              <input id="seaDepth" type="number" step="10" min="100" max="11000" value="4000">
            </div>
            <div>
              <label>æ´¥æ³¢é€Ÿåº¦ c (km/s)</label>
              <input id="tsuSpeed" type="number" step="0.001" min="0.05" max="0.40" value="0.198" />
              <small>c â‰ˆ âˆš(gÂ·h)/1000ï¼ˆåˆæœŸå€¤ã¯ h=4000m ç›¸å½“ï¼‰</small>
            </div>
          </div>
          <small>â€»ç°¡æ˜“ï¼šéœ‡æºã‹ã‚‰ã®æ°´å¹³è·é›¢ Ã· c ã‚’æ´¥æ³¢åˆ°é”æ™‚åˆ» T ã¨ã—ã¦ç®—å‡ºã€‚æ¸›è¡°ãƒ»å±ˆæŠ˜ãƒ»æ¹¾åŠ¹æœãªã©ã¯æœªè€ƒæ…®ã€‚</small>
        </div>
      </details>

      <!-- AIæ¨è«– -->
      <details class="section">
        <summary>AIæ¨è«–ï¼ˆAPIé€£æºï¼‰</summary>
        <div class="content">
          <label>API URL</label>
          <input id="aiUrl" type="url" placeholder="https://example.com/quake-ai">
          <label>API Keyï¼ˆå¿…è¦ãªã‚‰ï¼‰</label>
          <input id="aiKey" type="password" placeholder="ä»»æ„">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="aiFetch" class="primary">AIãƒ‡ãƒ¼ã‚¿å–å¾—</button>
            <button id="aiDemo" class="ghost">ãƒ‡ãƒ¢ç”Ÿæˆ</button>
            <button id="aiClear" class="ghost">AIé©ç”¨ã‚’ã‚¯ãƒªã‚¢</button>
          </div>
          <small>æœŸå¾…JSON: {"epicenters":[{"lat":35.5,"lng":140.1,"M":6.8,"depth":30}], "stations":[{"name":"Tokyo","lat":35.68,"lng":139.76}]}</small>
        </div>
      </details>
       <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆ / ä¿å­˜ãƒ»å…±æœ‰ -->
<details class="section" open>
  <summary>ãƒ—ãƒªã‚»ãƒƒãƒˆ / ä¿å­˜ãƒ»å…±æœ‰</summary>
  <div class="content">
    <div class="twoCol">
      <div>
        <label>ã‚·ãƒŠãƒªã‚ªãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
        <select id="presetScenario">
          <option value="none" selected>é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="nankai">å—æµ·ãƒˆãƒ©ãƒ•ï¼ˆM8.2 / h=20kmï¼‰</option>
          <option value="sagami">ç›¸æ¨¡ãƒˆãƒ©ãƒ•ï¼ˆM7.6 / h=30kmï¼‰</option>
          <option value="japantrench">æ—¥æœ¬æµ·æºï¼ˆM8.5 / h=25kmï¼‰</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;align-items:flex-end">
        <button id="applyPreset" class="primary">é©ç”¨</button>
        <button id="clearAll" class="ghost">å…¨æ¶ˆå»</button>
      </div>
    </div>

    <div class="twoCol">
      <div>
        <label>çŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="saveLocal" class="ghost">ä¿å­˜</button>
          <button id="loadLocal" class="ghost">èª­è¾¼</button>
          <button id="delLocal" class="ghost">å‰Šé™¤</button>
        </div>
      </div>
      <div>
        <label>ãƒ•ã‚¡ã‚¤ãƒ«</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="exportJson" class="ghost">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <label class="ghost" style="padding:8px 12px;cursor:pointer">
            ã‚¤ãƒ³ãƒãƒ¼ãƒˆ<input id="importJson" type="file" accept="application/json" style="display:none">
          </label>
        </div>
      </div>
    </div>

    <div class="twoCol">
      <div>
        <label>å…±æœ‰URL</label>
        <button id="copyPermalink" class="ghost">URLã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div>
        <label>ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</label>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="heatToggle">
            <option value="off" selected>ã‚ªãƒ•</option>
            <option value="on">ã‚ªãƒ³</option>
          </select>
          <input id="heatOpacity" type="range" min="0.1" max="1" step="0.05" value="0.5">
        </div>
      </div>
    </div>
    <small>ä¿å­˜ã¯ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã«ã€ŒquakeSimStateã€ã¨ã—ã¦è¨˜éŒ²ã€‚å…±æœ‰URLã¯çŠ¶æ…‹ã‚’åœ§ç¸®ã›ãšãã®ã¾ã¾åŸ‹ã‚è¾¼ã¿ã¾ã™ï¼ˆé•·ããªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚</small>
  </div>
</details>

      <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
      <details class="section">
        <summary>åˆ°é”ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆäºˆæ¸¬ï¼‰</summary>
        <div class="content" id="timeline">é–‹å§‹ã™ã‚‹ã¨ç›´è¿‘åˆ°é”é †ã«è¡¨ç¤º</div>
      </details>
    </aside>
  </div>
</div>

<!-- Overlay -->
<div id="overlay" aria-hidden="true">
  <div id="obg"></div>
  <div id="op">
    <h3 id="ovTitle">é€šçŸ¥</h3>
    <p id="ovMsg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="ovOk" class="primary">OK</button>
      <button id="ovClose" class="ghost">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<div class="version">vÎ²</div>

<script>
(()=>{'use strict';
/* ===== DOM ===== */
const $=id=>document.getElementById(id);
const titleView=$('title'), app=$('app');
const btnStart=$('btnStart'), btnTutorial=$('btnTutorial'), btnAIMode=$('btnAIMode');
const slideEls=[...document.querySelectorAll('#tRight .slide')];
const slideIndex=$('slideIndex'), prevSlide=$('prevSlide'), nextSlide=$('nextSlide');
const prev2=$('prev2'), next2=$('next2'), prev3=$('prev3'), startFromSlide=$('startFromSlide');

const mapEl=$('map');
const runStart=$('runStart'), runPause=$('runPause'), runResume=$('runResume'), runStop=$('runStop');
const modeSel=$('modeSel'), speedIn=$('speed');
const inMag=$('inMag'), inDepth=$('inDepth'), btnAddEpic=$('btnAddEpic'), epicList=$('epicList');
const stName=$('stName'), stLat=$('stLat'), stLon=$('stLon'), btnAddStation=$('btnAddStation'), btnClearStations=$('btnClearStations'), stList=$('stList');
const tileSel=$('tileSel'), tileOpacity=$('tileOpacity'), ringVis=$('ringVis'), hudVis=$('hudVis');
const vpIn=$('vp'), vsIn=$('vs'), attIn=$('att'), presetSel=$('modelPreset');
const hud=$('hud'), modeBadge=$('modeBadge'), timeline=$('timeline');
const overlay=$('overlay'), ovTitle=$('ovTitle'), ovMsg=$('ovMsg'), ovOk=$('ovOk'), ovClose=$('ovClose');
const muteSel=$('muteSel'), volIn=$('vol');
const ttsModeSel=$('ttsMode'), ttsRate=$('ttsRate');
const aiUrl=$('aiUrl'), aiKey=$('aiKey'), aiFetch=$('aiFetch'), aiDemo=$('aiDemo'), aiClear=$('aiClear');

/* æ´¥æ³¢ DOM */
const tsuModeSel = $('tsuMode'), tsuRingVis = $('tsuRingVis');
const seaDepthIn = $('seaDepth'), tsuSpeedIn = $('tsuSpeed');

/* ãƒ—ãƒªã‚»ãƒƒãƒˆ/ä¿å­˜/å…±æœ‰/ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— DOM */
const presetScenario=$('presetScenario'), applyPreset=$('applyPreset'), clearAll=$('clearAll');
const saveLocal=$('saveLocal'), loadLocal=$('loadLocal'), delLocal=$('delLocal');
const exportJson=$('exportJson'), importJson=$('importJson'), copyPermalink=$('copyPermalink');
const heatToggle=$('heatToggle'), heatOpacity=$('heatOpacity');

/* Overlay */
function showOverlay(t,m,ok){ ovTitle.textContent=t; ovMsg.textContent=m; overlay.style.display='flex'; ovOk.onclick=()=>{ if(ok) ok(); hideOverlay(); }; ovClose.onclick=hideOverlay; }
function hideOverlay(){ overlay.style.display='none'; }

/* ===== Tutorial nav ===== */
let sIdx=0;
function showSlide(i){
  sIdx=Math.max(0,Math.min(2,i));
  slideEls.forEach((el,idx)=> el.style.display = (idx===sIdx)?'block':'none');
  slideIndex.textContent=`ã‚¹ãƒ©ã‚¤ãƒ‰ ${sIdx+1} / 3`;
  prevSlide.disabled = (sIdx===0);
  nextSlide.disabled = (sIdx===2);
}
prevSlide.addEventListener('click', ()=>showSlide(sIdx-1));
nextSlide.addEventListener('click', ()=>showSlide(sIdx+1));
prev2.addEventListener('click', ()=>showSlide(0));
next2.addEventListener('click', ()=>showSlide(2));
prev3.addEventListener('click', ()=>showSlide(1));
startFromSlide?.addEventListener('click', startApp);
showSlide(0);

/* ===== Title actions ===== */
btnStart.addEventListener('click', startApp);
btnTutorial.addEventListener('click', ()=> showOverlay('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«','å³å´ã®ã€Œå‰ã¸ï¼æ¬¡ã¸ã€ã§1/3â†’3/3ã‚’ç§»å‹•ã§ãã¾ã™ã€‚'));
btnAIMode.addEventListener('click', ()=> showOverlay('AIæ¨è«–ãƒ¢ãƒ¼ãƒ‰','å³ãƒ‘ãƒãƒ«ã€ŒAIæ¨è«–ï¼ˆAPIé€£æºï¼‰ã€ã‹ã‚‰å–å¾—ã§ãã¾ã™ã€‚'));

/* ===== App State ===== */
let map, tiles=null;
let epicenters=[]; // {id, lat, lng, M, depth, marker, pCircle, sCircle, tCircle?}
let stations=[];   // {id, lat, lng, name, marker, nameMarker?, countdownMarker, pA, sA, tA, pred, isMajor, spoken}
let running=false, t0=null, tOffset=0, speed=1, vp=6.0, vs=3.5, dAtt=0.0035, ringsOn=true;
let lastTimelineUpdate=0;

/* æ´¥æ³¢ */
let tsunamiOn = false;
let tsuRingsOn = false;
let cT = 0.198; // km/sï¼ˆhâ‰ˆ4000mã‹ã‚‰ç®—å‡ºï¼‰

/* ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆç°¡æ˜“ï¼‰ */
let heatLayer = L.layerGroup(); // stationã”ã¨ã«åŠé€æ˜ã®å††ã‚’è¼‰ã›ã‚‹

/* ===== Audio ===== */
let audioCtx=null, masterGain=null;
function ensureAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = parseFloat(volIn.value)||0.35;
  masterGain.connect(audioCtx.destination);
}
function setVolume(v){ if(masterGain) masterGain.gain.value = v; }
function isMuted(){ return muteSel.value==='on'; }
function beep(freq=880, dur=0.12, type='sine', vol=0.5){
  if(isMuted()) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value=freq;
  g.gain.value = (parseFloat(volIn.value)||0.35)*vol;
  o.connect(g); g.connect(masterGain);
  const t = audioCtx.currentTime;
  o.start(t);
  g.gain.setValueAtTime(g.gain.value, t);
  g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
  o.stop(t+dur+0.02);
}
function eewChime(){
  if(isMuted()) return;
  ensureAudio();
  const seq = [{f:660,d:0.18},{f:880,d:0.22},{f:660,d:0.18},{f:880,d:0.22}];
  let t = audioCtx.currentTime;
  seq.forEach(s=>{
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='triangle'; o.frequency.value=s.f;
    g.gain.value=(parseFloat(volIn.value)||0.35)*0.5;
    o.connect(g); g.connect(masterGain);
    o.start(t); g.gain.setValueAtTime(g.gain.value,t);
    g.gain.exponentialRampToValueAtTime(0.0001, t+s.d);
    o.stop(t+s.d+0.02);
    t += s.d*1.05;
  });
}

/* ===== TTS ===== */
function ttsEnabled(){ return ttsModeSel.value!=='off' && 'speechSynthesis' in window; }
function shouldSpeak(st, idx){
  const mode = ttsModeSel.value;
  if(mode==='off') return false;
  if(mode==='all') return true;
  if(mode==='major') return !!st.isMajor;
  if(mode==='jma5') return idx>=4;
  return false;
}
function speakJP(text){
  if(!ttsEnabled()) return;
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ja-JP';
    u.rate = parseFloat(ttsRate.value)||1.0;
    window.speechSynthesis.speak(u);
  }catch(e){}
}

/* ===== Start App / Map ===== */
function startApp(){
  const tdiv=document.getElementById('title');
  tdiv.style.transition='opacity .25s'; tdiv.style.opacity='0';
  setTimeout(()=>{ tdiv.style.display='none'; app.style.display='block'; initMap(); },260);
}
function initMap(){
  map = L.map('map', { zoomControl:true, minZoom:4, maxZoom:12, preferCanvas:true, doubleClickZoom:false });
  setTiles(tileSel.value); tiles.setOpacity(parseFloat(tileOpacity.value)||1);
  map.setView([36.2048, 138.2529], 5);

  map.on('click', (e)=>{ if(getMode()!=='TOOL') return; addEpicAt(e.latlng.lat,e.latlng.lng); });
  map.on('dblclick', (e)=>{ if(getMode()!=='TOOL') return; addStationAt(e.latlng.lat,e.latlng.lng, stName.value.trim()||`è¦³æ¸¬ç‚¹${stations.length+1}`, true, false); });

  heatLayer.addTo(map);
  preloadStations();
}

/* ===== Base tiles ===== */
function setTiles(kind){
  if(tiles) map.removeLayer(tiles);
  if(kind==='bright'){
    tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{attribution:'Â©OpenStreetMap Â©Carto',maxZoom:19});
  }else if(kind==='toner'){
    tiles = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png',{attribution:'Map tiles by Stamen, Â©OpenStreetMap',maxZoom:20});
  }else{
    tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â©OpenStreetMap contributors',maxZoom:19});
  }
  tiles.addTo(map);
}

/* ===== Modes & HUD ===== */
function getMode(){ return modeSel.value; }
function setModeUI(){
  const m=getMode();
  modeBadge.textContent=`Mode: ${m}`;
  hud.textContent = m==='TOOL' ? 'ãƒ„ãƒ¼ãƒ«: ã‚¯ãƒªãƒƒã‚¯=éœ‡æº / ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—=è¦³æ¸¬ç‚¹ / ãƒ‰ãƒ©ãƒƒã‚°=ç§»å‹•'
               : m==='VIEW' ? 'ãƒ“ãƒ¥ãƒ¼: ç·¨é›†ç„¡åŠ¹ï¼ˆã‚ºãƒ¼ãƒ /ãƒ‘ãƒ³ã®ã¿ï¼‰' : 'AI: APIå–å¾—ã§è‡ªå‹•è¨­å®šï¼ˆå³ãƒ‘ãƒãƒ«ï¼‰';
  const disable = (m==='VIEW' && running);
  [inMag,inDepth,btnAddEpic,btnAddStation,btnClearStations,stName,stLat,stLon].forEach(el=> el.disabled=disable);
}
modeSel.addEventListener('change', ()=>{
  setModeUI();
  if(getMode()==='AI'){ showOverlay('AIæ¨è«–ãƒ¢ãƒ¼ãƒ‰','å³ãƒ‘ãƒãƒ«ã€ŒAIæ¨è«–ã€ã§APIã‚’è¨­å®šã—ã¦å–å¾—ã§ãã¾ã™ã€‚'); }
});
hudVis.addEventListener('change', ()=> {
  const on = (hudVis.value==='on');
  document.querySelectorAll('.hud,.badge').forEach(el=> el.style.display = on?'block':'none');
});

/* ===== Add Epic/Station ===== */
function clampMag(x){ return Math.max(-2, Math.min(12, isNaN(x)?6.5:x)); }
function clampDepth(x){ return Math.max(0.1, Math.min(750, isNaN(x)?30:x)); }

function addEpicAt(lat,lng){
  if(epicenters.length>=5){ showOverlay('ä¸Šé™','éœ‡æºã¯æœ€å¤§5ã¤ã¾ã§ã€‚'); return; }
  const M = clampMag(parseFloat(inMag.value));
  const depth = clampDepth(parseFloat(inDepth.value));
  const el = document.createElement('div'); el.className='epi-dot';
  const marker = L.marker([lat,lng], { draggable:true, icon: L.divIcon({html:el, className:'', iconSize:[18,18]}) }).addTo(map);
  marker.bindTooltip(`M${M.toFixed(1)} / ${depth.toFixed(1)}km`,{direction:'top',offset:[0,-16]});
  const epi={ id:'e'+Date.now()+Math.random(), lat,lng, M, depth, marker, pCircle:null, sCircle:null, tCircle:null };
  marker.on('dragend', ()=>{ const ll=marker.getLatLng(); epi.lat=ll.lat; epi.lng=ll.lng; computePredictions(); });
  marker.on('click', ()=>{ if(getMode()==='TOOL'){ const nm=parseFloat(prompt('M?',epi.M)); const dp=parseFloat(prompt('æ·±ã•(km)?',epi.depth)); if(!isNaN(nm)) epi.M=clampMag(nm); if(!isNaN(dp)) epi.depth=clampDepth(dp); marker.closeTooltip(); marker.bindTooltip(`M${epi.M.toFixed(1)} / ${epi.depth.toFixed(1)}km`); computePredictions(); }});
  epicenters.push(epi);
  refreshEpicList(); computePredictions();
}

function stationIconHTML(text=''){ return `<div class="station-dot">${text||''}</div>`; }
function makeNameIconHTML(name){ return `<div class="station-label">${name}</div>`; }
function makeCountdownHTML(txt){ return `<div class="countdown-pill">${txt}</div>`; }

function addStationAt(lat,lng,name, showLabel=true, isMajor=false){
  const icon = L.divIcon({ html: stationIconHTML(''), className:'', iconSize:[34,34] });
  const marker = L.marker([lat,lng],{ draggable:true, icon }).addTo(map);
  let nameMarker=null;
  if(showLabel && name){
    nameMarker = L.marker([lat,lng],{ icon: L.divIcon({ html: makeNameIconHTML(name), className:'', iconSize:null }), interactive:false }).addTo(map);
  }
  const countdown = L.marker([lat,lng],{ icon:L.divIcon({html:makeCountdownHTML(''),className:'',iconSize:null}), interactive:false }).addTo(map);

  const st={ id:'s'+Date.now()+Math.random(), lat,lng, name, marker, nameMarker, countdownMarker:countdown, pA:false, sA:false, tA:false, pred:null, isMajor, spoken:false };
  marker.on('drag', ()=>{ const ll=marker.getLatLng(); st.lat=ll.lat; st.lng=ll.lng; if(nameMarker) nameMarker.setLatLng(ll); countdown.setLatLng(ll); });
  marker.on('dragend', ()=>{ computePredictions(); });
  marker.on('click', ()=>{ if(getMode()==='TOOL'){ const nm=prompt('è¦³æ¸¬ç‚¹å', st.name||''); if(nm!==null){ st.name=nm.trim(); if(st.name){ if(!nameMarker){ nameMarker = L.marker([lat,lng],{ icon: L.divIcon({ html: makeNameIconHTML(st.name), className:'', iconSize:null }), interactive:false }).addTo(map); st.nameMarker=nameMarker; } else { nameMarker.setIcon(L.divIcon({html:makeNameIconHTML(st.name),className:'',iconSize:null})); } } else if(nameMarker){ map.removeLayer(nameMarker); st.nameMarker=null; } refreshStList(); } }});
  stations.push(st);
  refreshStList(); computePredictions();
}

/* åˆæœŸé…ç½® */
function preloadStations(){
  const major = [
    {name:'æœ­å¹Œ',lat:43.0618,lng:141.3545},{name:'ä»™å°',lat:38.2688,lng:140.8721},
    {name:'æ±äº¬',lat:35.6812,lng:139.7671},{name:'æ¨ªæµœ',lat:35.4437,lng:139.6380},
    {name:'åƒè‘‰',lat:35.6073,lng:140.1063},{name:'ã•ã„ãŸã¾',lat:35.8617,lng:139.6455},
    {name:'å·å´',lat:35.5300,lng:139.7036},{name:'é™å²¡',lat:34.9710,lng:138.3889},
    {name:'åå¤å±‹',lat:35.1815,lng:136.9066},{name:'äº¬éƒ½',lat:35.0116,lng:135.7681},
    {name:'å¤§é˜ª',lat:34.6937,lng:135.5023},{name:'ç¥æˆ¸',lat:34.6901,lng:135.1955},
    {name:'åºƒå³¶',lat:34.3853,lng:132.4553},{name:'å²¡å±±',lat:34.6551,lng:133.9195},
    {name:'ç¦å²¡',lat:33.5902,lng:130.4017},{name:'åŒ—ä¹å·',lat:33.8830,lng:130.8753},
    {name:'ç†Šæœ¬',lat:32.8031,lng:130.7079},
  ];
  major.forEach(c=> addStationAt(c.lat,c.lng,c.name,true,true));
  const extra = [
    {lat:41.7687,lng:140.7288},{lat:40.8220,lng:140.7473},{lat:39.7199,lng:140.1024},
    {lat:37.9161,lng:139.0364},{lat:36.5613,lng:136.6562},{lat:36.6513,lng:138.1809},
    {lat:35.4233,lng:136.7607},{lat:34.6851,lng:135.8327},{lat:34.2260,lng:135.1675},
    {lat:33.8416,lng:132.7661},{lat:33.5597,lng:133.5311},{lat:34.0703,lng:134.5548},
    {lat:35.5039,lng:134.2377},{lat:35.4723,lng:133.0505},{lat:33.2396,lng:131.6093},
    {lat:31.9077,lng:131.4202},{lat:31.5966,lng:130.5571},{lat:26.2125,lng:127.6811},
  ];
  extra.forEach(p=> addStationAt(p.lat,p.lng,'', false, false));
}

/* ===== Lists ===== */
function refreshEpicList(){
  epicList.innerHTML='';
  if(epicenters.length===0){ epicList.textContent='éœ‡æºãªã—'; return; }
  epicenters.forEach((e)=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.margin='4px 0';
    const left=document.createElement('div'); left.innerHTML=`<b>M${e.M.toFixed(1)}</b> / ${e.depth.toFixed(1)}km @ ${e.lat.toFixed(2)},${e.lng.toFixed(2)}`;
    const right=document.createElement('div');
    const del=document.createElement('button'); del.className='ghost'; del.textContent='å‰Šé™¤';
    del.onclick=()=>{ if(e.pCircle) map.removeLayer(e.pCircle); if(e.sCircle) map.removeLayer(e.sCircle); if(e.tCircle) map.removeLayer(e.tCircle); map.removeLayer(e.marker); epicenters=epicenters.filter(x=>x.id!==e.id); computePredictions(); refreshEpicList(); };
    right.appendChild(del); row.appendChild(left); row.appendChild(right); epicList.appendChild(row);
  });
}
function refreshStList(){
  stList.innerHTML='';
  if(stations.length===0){ stList.textContent='è¦³æ¸¬ç‚¹ãªã—'; return; }
  stations.forEach((s)=>{
    const nm = s.name && s.name.trim() ? s.name : '(åç§°ãªã—)';
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.margin='4px 0';
    const left=document.createElement('div'); left.innerHTML=`<b>${nm}</b> <span class="small">@${s.lat.toFixed(3)},${s.lng.toFixed(3)}</span>` + (s.pred?` <span class="small">/ äºˆæ¸¬:${s.pred.jma.sh} P:${s.pred.arrP.toFixed(1)}s S:${s.pred.arrS.toFixed(1)}s${(isFinite(s.pred.arrT)?` T:${s.pred.arrT.toFixed(1)}s`:'')}</span>`:'');
    const right=document.createElement('div');
    const del=document.createElement('button'); del.className='ghost'; del.textContent='å‰Šé™¤';
    del.onclick=()=>{ map.removeLayer(s.marker); if(s.nameMarker) map.removeLayer(s.nameMarker); map.removeLayer(s.countdownMarker); stations=stations.filter(x=>x.id!==s.id); refreshStList(); computePredictions(); };
    right.appendChild(del); row.appendChild(left); row.appendChild(right); stList.appendChild(row);
  });
}

/* ===== Tiles, HUD, opacity â€“ ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆé‡è¤‡ã¯ã“ã“ã ã‘ï¼‰ ===== */
tileSel.addEventListener('change', ()=> setTiles(tileSel.value));
tileOpacity.addEventListener('input', ()=> { if(tiles) tiles.setOpacity(parseFloat(tileOpacity.value)||1); });
ringVis.addEventListener('change', ()=>{ ringsOn = (ringVis.value==='on'); updateRingVisibility(); });
muteSel.addEventListener('change', ()=>{ if(!isMuted()) ensureAudio(); });
volIn.addEventListener('input', ()=> setVolume(parseFloat(volIn.value)||0.35));

/* ===== Simulation control ===== */
runStart.addEventListener('click', ()=>{
  if(epicenters.length===0){ showOverlay('éœ‡æºæœªè¨­å®š','ã¾ãšéœ‡æºã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚'); return; }
  vp = parseFloat(vpIn.value)||6.0; vs=parseFloat(vsIn.value)||3.5; dAtt=parseFloat(attIn.value)||0.0035;
  running=true; t0=performance.now(); tOffset=0; speed=parseFloat(speedIn.value)||1;
  modeSel.value='VIEW'; setModeUI();
  setupCircles();
  runStart.disabled=true; runStop.disabled=false; runPause.disabled=false; runResume.disabled=true;
});
runPause.addEventListener('click', ()=>{ if(!running) return; tOffset = getElapsed(); running=false; runPause.disabled=true; runResume.disabled=false; });
runResume.addEventListener('click', ()=>{ if(running) return; t0=performance.now(); running=true; runPause.disabled=false; runResume.disabled=true; });
runStop.addEventListener('click', stopSim);

presetSel.addEventListener('change', ()=>{
  if(presetSel.value==='dStrong') attIn.value = 0.005;
  else if(presetSel.value==='dLight') attIn.value = 0.002;
  else attIn.value = 0.0035;
  dAtt=parseFloat(attIn.value)||0.0035; computePredictions();
});
vpIn.addEventListener('change', ()=>{ vp=parseFloat(vpIn.value)||6.0; computePredictions(); });
vsIn.addEventListener('change', ()=>{ vs=parseFloat(vsIn.value)||3.5; computePredictions(); });
attIn.addEventListener('input', ()=>{ dAtt=parseFloat(attIn.value)||0.0035; computePredictions(); });

function stopSim(){
  running=false; t0=null; tOffset=0;
  epicenters.forEach(e=>{ if(e.pCircle) map.removeLayer(e.pCircle); if(e.sCircle) map.removeLayer(e.sCircle); if(e.tCircle) map.removeLayer(e.tCircle); e.pCircle=null; e.sCircle=null; e.tCircle=null; });
  stations.forEach(s=>{ s.pA=false; s.sA=false; s.tA=false; s.spoken=false; updateStationBadge(s,''); updateCountdown(s,''); });
  if('speechSynthesis' in window) window.speechSynthesis.cancel();
  runStart.disabled=false; runStop.disabled=true; runPause.disabled=true; runResume.disabled=true;
  timeline.innerHTML='åœæ­¢ä¸­ã€‚Startã§å†é–‹ã§ãã¾ã™ã€‚';
}

function getElapsed(){ if(!running) return tOffset; if(!t0) return tOffset; return tOffset + (performance.now()-t0)/1000*speed; }

/* ===== Physics / Prediction ===== */
function hav(lat1,lng1,lat2,lng2){ const R=6371e3; const toRad=Math.PI/180; const dLat=(lat2-lat1)*toRad, dLng=(lng2-lng1)*toRad; const a=Math.sin(dLat/2)**2 + Math.cos(lat1*toRad)*Math.cos(lat2*toRad)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(a)); }
function arrivals(epi, st){
  const h = hav(epi.lat, epi.lng, st.lat, st.lng)/1000;
  const R = Math.sqrt(h*h + epi.depth*epi.depth);
  return { tP:R/vp, tS:R/vs, Rkm:R, Hkm:h };
}
function estimatePGA(M, Rkm){
  const a=-1.2, b=0.45, c=1.1, d=dAtt;
  const lg = a + b*M - c*Math.log10(Math.max(1, Rkm)) - d*Rkm;
  return Math.pow(10, lg);
}
function pgaToJMA(pga){
  if(pga>1.0) return {sh:'7', idx:8};
  if(pga>0.6) return {sh:'6å¼·', idx:7};
  if(pga>0.3) return {sh:'6å¼±', idx:6};
  if(pga>0.15) return {sh:'5å¼·', idx:5};
  if(pga>0.06) return {sh:'5å¼±', idx:4};
  if(pga>0.025) return {sh:'4', idx:3};
  if(pga>0.01) return {sh:'3', idx:2};
  if(pga>0.003) return {sh:'2', idx:1};
  return {sh:'1', idx:0};
}
function colorForIdx(i){
  const pal=["#9ebed6","#7fc9c9","#6de0a8","#f7e86b","#ffd27a","#ffb06b","#ff8a5f","#ff5a5a","#c83b3b"];
  return pal[Math.max(0,Math.min(pal.length-1,i))];
}

/* æ´¥æ³¢ */
function depthToSpeedKmPerS(h_m){ return Math.sqrt(9.81 * Math.max(100, h_m)) / 1000; } // âˆš(gÂ·h)/1000

function computePredictions(){
  stations.forEach(s=>{
    let best=null;
    epicenters.forEach(e=>{
      const at=arrivals(e,s);
      const pga=estimatePGA(e.M, Math.max(0.5, at.Rkm));
      const jma=pgaToJMA(pga);
      const pred={arrP:at.tP, arrS:at.tS, pga, jma, color:colorForIdx(jma.idx)};
      if(!best || pred.jma.idx>best.jma.idx) best=pred;
    });

    if(best){
      let minH = Infinity;
      epicenters.forEach(e=>{
        const h = hav(e.lat, e.lng, s.lat, s.lng)/1000; // km
        if(h<minH) minH = h;
      });
      best.arrT = (tsunamiOn && isFinite(minH) && cT>0) ? (minH / cT) : Infinity;
    }

    s.pred=best; s.pA=false; s.sA=false; s.tA=false; s.spoken=false;
    updateStationBadge(s,''); updateCountdown(s,'');
  });
  updateHeatLayer();
  updateTimeline();
}

/* ===== P/S/T Rings ===== */
function setupCircles(){
  epicenters.forEach(e=>{
    if(e.pCircle) map.removeLayer(e.pCircle);
    if(e.sCircle) map.removeLayer(e.sCircle);
    if(e.tCircle) map.removeLayer(e.tCircle);
    e.pCircle = L.circle([e.lat,e.lng],{radius:0,color:'rgba(80,170,255,0.5)', weight:2, fill:false});
    e.sCircle = L.circle([e.lat,e.lng],{radius:0,color:'rgba(255,100,100,0.4)', weight:2, fill:false});
    e.tCircle = L.circle([e.lat,e.lng],{radius:0,color:'rgba(80,255,200,0.45)', weight:2, fill:false});
    if(ringsOn){ e.pCircle.addTo(map); e.sCircle.addTo(map); }
    if(tsuRingsOn && tsunamiOn){ e.tCircle.addTo(map); }
  });
}
function updateRingVisibility(){
  epicenters.forEach(e=>{
    if(e.pCircle){
      if(ringsOn){ e.pCircle.addTo(map); } else { map.removeLayer(e.pCircle); }
    }
    if(e.sCircle){
      if(ringsOn){ e.sCircle.addTo(map); } else { map.removeLayer(e.sCircle); }
    }
    if(e.tCircle){
      if(tsuRingsOn && tsunamiOn){ e.tCircle.addTo(map); } else { map.removeLayer(e.tCircle); }
    }
  });
}

/* ===== Station UI ===== */
function updateStationBadge(st, text){
  st.marker.setIcon( L.divIcon({ html: stationIconHTML(text), className:'', iconSize:[34,34] }) );
}
function updateCountdown(st, txt){
  if(!st.countdownMarker) return;
  st.countdownMarker.setIcon( L.divIcon({html:makeCountdownHTML(txt||''),className:'',iconSize:null}) );
}

/* ===== Timeline ===== */
function updateTimeline(){
  if(!running){ timeline.innerHTML='åœæ­¢ä¸­ã€‚Startã§å†é–‹ã§ãã¾ã™ã€‚'; return; }
  const t=getElapsed();
  const rows=[];
  stations.forEach(s=>{
    if(!s.pred) return;
    if(!s.pA) rows.push({name:s.name||'(ç„¡å)', type:'P', in: Math.max(0, s.pred.arrP - t)});
    if(!s.sA) rows.push({name:s.name||'(ç„¡å)', type:'S', in: Math.max(0, s.pred.arrS - t)});
    if(tsunamiOn && !s.tA && isFinite(s.pred.arrT)) rows.push({name:s.name||'(ç„¡å)', type:'T', in: Math.max(0, s.pred.arrT - t)});
  });
  rows.sort((a,b)=>a.in-b.in);
  const html = rows.slice(0,16).map(r=>`<div>${r.in.toFixed(1)}s â†’ <b>${r.type}</b> @ ${r.name}</div>`).join('') || 'å…¨ã¦åˆ°é”æ¸ˆã¿';
  timeline.innerHTML = html;
}

/* ===== Loop ===== */
function loop(){
  if(running){
    const t=getElapsed();
    epicenters.forEach(e=>{
      const rP=Math.max(0, t*vp*1000);
      const rS=Math.max(0, t*vs*1000);
      if(e.pCircle) e.pCircle.setRadius(rP);
      if(e.sCircle) e.sCircle.setRadius(rS);
      const rT=Math.max(0, t*cT*1000); // km/s * s -> km -> m
      if(e.tCircle) e.tCircle.setRadius(rT);
    });
    stations.forEach(s=>{
      if(!s.pred) return;

      if(!s.pA){
        const left = s.pred.arrP - t;
        updateCountdown(s, left>0 ? `P ${left.toFixed(1)}s` : '');
        if(left<=0 && !s.pA){ s.pA=true; beep(900,0.08,'sine',0.35); }
      }else if(!s.sA){
        const left = s.pred.arrS - t;
        updateCountdown(s, left>0 ? `S ${left.toFixed(1)}s` : '');
        if(left<=0 && !s.sA){
          s.sA=true;
          updateCountdown(s,'');
          updateStationBadge(s, s.pred.jma.sh);
          if(s.pred.jma.idx>=4) eewChime(); else beep(640,0.12,'square',0.4);
          if(!s.spoken && shouldSpeak(s, s.pred.jma.idx)){
            const nm = s.name && s.name.trim() ? s.name : 'è¦³æ¸¬ç‚¹';
            speakJP(`${nm}ã€äºˆæƒ³éœ‡åº¦ã€${s.pred.jma.sh}`);
            s.spoken=true;
          }
        }
      }

      if(tsunamiOn && !s.tA && isFinite(s.pred.arrT)){
        const leftT = s.pred.arrT - t;
        if(leftT<=0){
          s.tA = true;
          if(!s.sA) updateStationBadge(s, 'ğŸŒŠ');
          beep(520, 0.18, 'sine', 0.5);
        }
      }

      const leftP = s.pA ? Infinity : (s.pred.arrP - t);
      const leftS = s.sA ? Infinity : (s.pred.arrS - t);
      const leftT = (!tsunamiOn || s.tA || !isFinite(s.pred.arrT)) ? Infinity : (s.pred.arrT - t);
      const minLeft = Math.min(leftP, leftS, leftT);
      if(isFinite(minLeft)){
        const label = (minLeft===leftP) ? `P ${Math.max(0,leftP).toFixed(1)}s`
                     : (minLeft===leftS) ? `S ${Math.max(0,leftS).toFixed(1)}s`
                     : `T ${Math.max(0,leftT).toFixed(1)}s`;
        updateCountdown(s, label);
      }else{
        updateCountdown(s,'');
      }
    });
    const now=performance.now();
    if(now-lastTimelineUpdate>250){ updateTimeline(); lastTimelineUpdate=now; }
  }
  requestAnimationFrame(loop);
}

/* ===== Manual add buttons ===== */
btnAddEpic.addEventListener('click', ()=>{ const c=map.getCenter(); addEpicAt(c.lat,c.lng); });
btnAddStation.addEventListener('click', ()=>{
  let name = stName.value.trim();
  let lat = parseFloat(stLat.value);
  let lng = parseFloat(stLon.value);
  if(!isFinite(lat) || !isFinite(lng)){ const c = map.getCenter(); lat = c.lat; lng = c.lng; }
  addStationAt(lat, lng, name || `è¦³æ¸¬ç‚¹${stations.length+1}`, true, false);
  if(name) stName.value = '';
});
btnClearStations.addEventListener('click', ()=>{
  stations.forEach(s=>{ if(s.marker) map.removeLayer(s.marker); if(s.nameMarker) map.removeLayer(s.nameMarker); if(s.countdownMarker) map.removeLayer(s.countdownMarker); });
  stations = [];
  refreshStList();
  timeline.innerHTML = 'è¦³æ¸¬ç‚¹ã‚’å…¨å‰Šé™¤ã—ã¾ã—ãŸã€‚';
  computePredictions();
});

/* ===== é€Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ ===== */
speedIn.addEventListener('input', ()=>{ speed = parseFloat(speedIn.value) || 1; });

/* ===== æ´¥æ³¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ===== */
function ensureTsunamiCircles(){
  epicenters.forEach(e=>{
    if(!e.tCircle){
      e.tCircle = L.circle([e.lat,e.lng],{ radius:0, color:'rgba(80,255,200,0.45)', weight:2, fill:false });
      if(tsuRingsOn && tsunamiOn) e.tCircle.addTo(map);
    }
  });
}

tsuModeSel.addEventListener('change', ()=>{
  tsunamiOn = (tsuModeSel.value === 'on');
  if(tsunamiOn){
    cT = parseFloat(tsuSpeedIn.value) || cT;
    ensureTsunamiCircles();
  }
  updateRingVisibility();
  computePredictions();
  updateTimeline();
});

tsuRingVis.addEventListener('change', ()=>{
  tsuRingsOn = (tsuRingVis.value === 'on');
  if(tsuRingsOn && tsunamiOn) ensureTsunamiCircles();
  updateRingVisibility();
});

seaDepthIn.addEventListener('change', ()=>{
  const h = Math.max(100, parseFloat(seaDepthIn.value) || 4000);
  cT = depthToSpeedKmPerS(h);
  tsuSpeedIn.value = cT.toFixed(3);
  computePredictions();
});

tsuSpeedIn.addEventListener('change', ()=>{
  const v = parseFloat(tsuSpeedIn.value);
  if(isFinite(v) && v>0){
    cT = Math.max(0.01, Math.min(0.8, v));
    computePredictions();
  }
});

/* ===== ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼ˆç°¡æ˜“ï¼‰ ===== */
function updateHeatLayer(){
  heatLayer.clearLayers();
  if(heatToggle.value!=='on') return;
  const opacity = parseFloat(heatOpacity.value)||0.5;
  stations.forEach(s=>{
    if(!s.pred) return;
    const idx = s.pred.jma.idx; // 0..8
    const r = 12000 + idx*6000; // åŠå¾„ï¼ˆmï¼‰å°‘ã—å¼·èª¿
    const col = s.pred.color || '#ff5a5a';
    const c = L.circle([s.lat,s.lng],{
      radius:r,
      color:col,
      weight:1,
      fill:true,
      fillOpacity:opacity*0.35,
      opacity:opacity*0.85
    });
    heatLayer.addLayer(c);
  });
}
heatToggle.addEventListener('change', updateHeatLayer);
heatOpacity.addEventListener('input', updateHeatLayer);

/* ===== ãƒ—ãƒªã‚»ãƒƒãƒˆ / ä¿å­˜ãƒ»å…±æœ‰ ===== */
applyPreset.addEventListener('click', ()=>{
  const v = presetScenario.value;
  if(v==='none'){ showOverlay('ãƒ—ãƒªã‚»ãƒƒãƒˆ','ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
  // å…¨æ¶ˆå»
  epicenters.forEach(e=>{ if(e.marker) map.removeLayer(e.marker); });
  epicenters=[]; refreshEpicList();
  // ä»£è¡¨å€¤ï¼ˆæ¦‚ç•¥ï¼‰
  let preset;
  if(v==='nankai'){ preset = {lat:33.0, lng:137.5, M:8.2, depth:20}; }
  if(v==='sagami'){ preset = {lat:34.8, lng:139.2, M:7.6, depth:30}; }
  if(v==='japantrench'){ preset = {lat:38.5, lng:143.0, M:8.5, depth:25}; }
  inMag.value = preset.M; inDepth.value = preset.depth;
  addEpicAt(preset.lat, preset.lng);
  computePredictions();
  showOverlay('ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨', 'éœ‡æºã‚’è¨­å®šã—ã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦è¦³æ¸¬ç‚¹ã‚’ç·¨é›†ã—ã¦ãã ã•ã„ã€‚');
});
clearAll.addEventListener('click', ()=>{
  // éœ‡æº
  epicenters.forEach(e=>{ if(e.marker) map.removeLayer(e.marker); if(e.pCircle) map.removeLayer(e.pCircle); if(e.sCircle) map.removeLayer(e.sCircle); if(e.tCircle) map.removeLayer(e.tCircle); });
  epicenters=[]; refreshEpicList();
  // è¦³æ¸¬ç‚¹
  stations.forEach(s=>{ if(s.marker) map.removeLayer(s.marker); if(s.nameMarker) map.removeLayer(s.nameMarker); if(s.countdownMarker) map.removeLayer(s.countdownMarker); });
  stations=[]; refreshStList();
  // ãƒªãƒ³ã‚°/ãƒ’ãƒ¼ãƒˆ
  heatLayer.clearLayers();
  computePredictions();
  showOverlay('å…¨æ¶ˆå»','éœ‡æºã¨è¦³æ¸¬ç‚¹ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚');
});

const LS_KEY='quakeSimState';
function serializeState(){
  return {
    params:{ vp:parseFloat(vpIn.value)||6, vs:parseFloat(vsIn.value)||3.5, att:parseFloat(attIn.value)||0.0035, tsunamiOn, tsuRingsOn, cT, sea:parseFloat(seaDepthIn.value)||4000 },
    epicenters: epicenters.map(e=>({lat:e.lat,lng:e.lng,M:e.M,depth:e.depth})),
    stations: stations.map(s=>({lat:s.lat,lng:s.lng,name:s.name||'',isMajor:!!s.isMajor}))
  };
}
function restoreState(obj){
  // clear current
  epicenters.forEach(e=>{ if(e.marker) map.removeLayer(e.marker); if(e.pCircle) map.removeLayer(e.pCircle); if(e.sCircle) map.removeLayer(e.sCircle); if(e.tCircle) map.removeLayer(e.tCircle); });
  epicenters=[]; refreshEpicList();
  stations.forEach(s=>{ if(s.marker) map.removeLayer(s.marker); if(s.nameMarker) map.removeLayer(s.nameMarker); if(s.countdownMarker) map.removeLayer(s.countdownMarker); });
  stations=[]; refreshStList();

  if(obj?.params){
    vpIn.value = obj.params.vp ?? 6; vsIn.value = obj.params.vs ?? 3.5; attIn.value = obj.params.att ?? 0.0035;
    seaDepthIn.value = obj.params.sea ?? 4000; cT = obj.params.cT ?? depthToSpeedKmPerS(parseFloat(seaDepthIn.value));
    tsuModeSel.value = obj.params.tsunamiOn ? 'on' : 'off';
    tsuRingVis.value = obj.params.tsuRingsOn ? 'on' : 'off';
    tsunamiOn = !!obj.params.tsunamiOn; tsuRingsOn = !!obj.params.tsuRingsOn;
  }
  (obj?.epicenters||[]).forEach(e=>{ inMag.value=e.M; inDepth.value=e.depth; addEpicAt(e.lat,e.lng); });
  (obj?.stations||[]).forEach(s=> addStationAt(s.lat,s.lng,s.name||'',true,!!s.isMajor));

  fitToAll();
  computePredictions();
}
function fitToAll(){
  const pts = [];
  epicenters.forEach(e=> pts.push([e.lat, e.lng]));
  stations.forEach(s=> pts.push([s.lat, s.lng]));
  if(pts.length){
    const b = L.latLngBounds(pts);
    map.fitBounds(b.pad(0.2));
  }
}

saveLocal.addEventListener('click', ()=>{ try{ localStorage.setItem(LS_KEY, JSON.stringify(serializeState())); showOverlay('ä¿å­˜','ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸã€‚'); }catch(e){ showOverlay('ä¿å­˜å¤±æ•—', String(e?.message||e)); } });
loadLocal.addEventListener('click', ()=>{ try{ const raw=localStorage.getItem(LS_KEY); if(!raw) return showOverlay('èª­è¾¼','ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); restoreState(JSON.parse(raw)); showOverlay('èª­è¾¼','ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚'); }catch(e){ showOverlay('èª­è¾¼å¤±æ•—', String(e?.message||e)); } });
delLocal.addEventListener('click', ()=>{ localStorage.removeItem(LS_KEY); showOverlay('å‰Šé™¤','ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚'); });

exportJson.addEventListener('click', ()=>{
  const data = JSON.stringify(serializeState(), null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='quakeSimState.json'; a.click();
  URL.revokeObjectURL(url);
});
importJson.addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  try{
    const text = await f.text();
    const obj = JSON.parse(text);
    restoreState(obj);
    showOverlay('ã‚¤ãƒ³ãƒãƒ¼ãƒˆ','ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
  }catch(e){ showOverlay('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—', String(e?.message||e)); }
  importJson.value = '';
});
copyPermalink.addEventListener('click', async ()=>{
  try{
    const payload = encodeURIComponent(JSON.stringify(serializeState()));
    const url = location.origin + location.pathname + '#state=' + payload;
    await navigator.clipboard.writeText(url);
    showOverlay('å…±æœ‰URL','ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');
  }catch(e){ showOverlay('ã‚³ãƒ”ãƒ¼å¤±æ•—', String(e?.message||e)); }
});
// èµ·å‹•æ™‚ã«ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒ
window.addEventListener('load', ()=>{
  const m = location.hash.match(/#state=(.+)$/);
  if(m){ try{ const obj = JSON.parse(decodeURIComponent(m[1])); // initMapå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†å°‘ã—é…å»¶
    setTimeout(()=> restoreState(obj), 400);
  }catch{} }
});

/* ===== AI é€£æº ===== */
function applyAI(data){
  try{
    let addedE = 0, addedS = 0;
    if(Array.isArray(data.epicenters)){
      data.epicenters.forEach(ep=>{
        if(!isFinite(ep.lat) || !isFinite(ep.lng)) return;
        addEpicAt(ep.lat, ep.lng);
        const e = epicenters[epicenters.length-1];
        if(e){
          if(isFinite(ep.M)) e.M = clampMag(parseFloat(ep.M));
          if(isFinite(ep.depth)) e.depth = clampDepth(parseFloat(ep.depth));
          e.marker.bindTooltip(`M${e.M.toFixed(1)} / ${e.depth.toFixed(1)}km`);
          e.ai = true;
          addedE++;
        }
      });
    }
    if(Array.isArray(data.stations)){
      data.stations.forEach(st=>{
        if(!isFinite(st.lat) || !isFinite(st.lng)) return;
        addStationAt(st.lat, st.lng, st.name||'', true, !!st.isMajor);
        const s = stations[stations.length-1];
        if(s){ s.ai = true; addedS++; }
      });
    }
    computePredictions();
    fitToAll();
    showOverlay('AIé©ç”¨', `éœ‡æº${addedE}ä»¶ãƒ»è¦³æ¸¬ç‚¹${addedS}ä»¶ã‚’åæ˜ ã—ã¾ã—ãŸã€‚`);
  }catch(err){
    showOverlay('AIé©ç”¨ã‚¨ãƒ©ãƒ¼', String(err?.message || err || 'unknown'));
  }
}
aiFetch.addEventListener('click', async ()=>{
  const url = aiUrl.value.trim();
  if(!url){ showOverlay('URLæœªå…¥åŠ›','API URL ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
  try{
    const headers = {};
    const key = aiKey.value.trim();
    if(key) headers['Authorization'] = 'Bearer '+key;
    const res = await fetch(url, { headers });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    applyAI(data);
  }catch(err){
    showOverlay('å–å¾—å¤±æ•—', `AIãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—: ${err.message || err}`);
  }
});
aiDemo.addEventListener('click', ()=>{
  const demo = {
    epicenters: [{ lat:33.0, lng:137.5, M:7.3, depth:20 }],
    stations: [
      { name:'é«˜çŸ¥', lat:33.5597, lng:133.5311 },
      { name:'å’Œæ­Œå±±', lat:34.2305, lng:135.1708 },
      { name:'åå¤å±‹', lat:35.1815, lng:136.9066, isMajor:true }
    ]
  };
  applyAI(demo);
});
aiClear.addEventListener('click', ()=>{
  let removedE = 0, removedS = 0;
  epicenters = epicenters.filter(e=>{
    if(e.ai){
      if(e.marker) map.removeLayer(e.marker);
      if(e.pCircle) map.removeLayer(e.pCircle);
      if(e.sCircle) map.removeLayer(e.sCircle);
      if(e.tCircle) map.removeLayer(e.tCircle);
      removedE++; return false;
    }
    return true;
  });
  stations = stations.filter(s=>{
    if(s.ai){
      if(s.marker) map.removeLayer(s.marker);
      if(s.nameMarker) map.removeLayer(s.nameMarker);
      if(s.countdownMarker) map.removeLayer(s.countdownMarker);
      removedS++; return false;
    }
    return true;
  });
  refreshEpicList(); refreshStList(); computePredictions();
  showOverlay('AIé©ç”¨ã‚’ã‚¯ãƒªã‚¢', `AIè¿½åŠ ã®éœ‡æº${removedE}ä»¶ãƒ»è¦³æ¸¬ç‚¹${removedS}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
});

/* ===== ä»•ä¸Šã’ï¼šãƒ«ãƒ¼ãƒ—é–‹å§‹ ===== */
loop();

})(); // IIFE ã“ã“ã¾ã§

</script>
</body>
</html>
